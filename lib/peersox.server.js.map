{"version":3,"sources":["webpack://peersox/webpack/universalModuleDefinition","webpack://peersox/webpack/bootstrap","webpack://peersox/external \"util\"","webpack://peersox/external \"crypto\"","webpack://peersox/external \"body-parser\"","webpack://peersox/external \"string-hash\"","webpack://peersox/external \"ws\"","webpack://peersox/./src/server/utils/index.js","webpack://peersox/./src/common/classes.js","webpack://peersox/./src/server/Store.js","webpack://peersox/./src/server/API.js","webpack://peersox/./src/common/dataparser.js","webpack://peersox/./src/common/settings.js","webpack://peersox/./src/server/Socket.js","webpack://peersox/./src/server.js"],"names":["buildRandomHex","random","crypto","randomBytes","toString","createHash","update","digest","buildRandomCode","hash","String","Math","round","substring","isString","v","codeIsValid","code","length","test","hashIsValid","pairingIsValid","pairing","Pairing","constructor","Validation","isValid","EXPIRE_CODE","EXPIRE_PAIRED","Store","redisClient","redisGet","promisify","get","bind","redisSet","set","redisExists","exists","redisDel","del","redisExpire","expire","_redisReady","on","console","log","keyExists","res","generateHash","alreadyUsed","generateCode","numericHash","stringHash","generatePairing","hashIsSet","codeIsSet","Error","getPairingFromCode","validatePairing","hashExists","API","app","server","store","middleware","config","use","bodyParser","urlencoded","extended","json","routeConfig","routeCodeGet","post","routeCodeValidate","routePairingValidate","getConfig","req","e","status","send","then","catch","err","body","validation","decode","data","JSON","parse","encode","name","stringify","INTERNAL_MESSAGE_PREFIX","HANDSHAKE_SUCCESS","HANDSHAKE_FAILED","PING","require","inspect","defaultOptions","depth","Socket","socketserver","WebSocketServer","path","messageHandlers","onMessageRegister","onMessageData","onConnection","connections","onMessageClose","client","_pairing","_peer","readyState","close","binaryType","peer","sendInternalEvent","isInitiator","eventName","closed","messageRaw","charAt","message","call","PeerSoxServer","socket","api"],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC;AACD,O;ACVA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;;AAGA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA,kDAA0C,gCAAgC;AAC1E;AACA;;AAEA;AACA;AACA;AACA,gEAAwD,kBAAkB;AAC1E;AACA,yDAAiD,cAAc;AAC/D;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iDAAyC,iCAAiC;AAC1E,wHAAgH,mBAAmB,EAAE;AACrI;AACA;;AAEA;AACA;AACA;AACA,mCAA2B,0BAA0B,EAAE;AACvD,yCAAiC,eAAe;AAChD;AACA;AACA;;AAEA;AACA,8DAAsD,+DAA+D;;AAErH;AACA;;;AAGA;AACA;;;;;;;AClFA,iC;;;;;;ACAA,mC;;;;;;ACAA,wC;;;;;;ACAA,wC;;;;;;ACAA,gD;;;;;;;;;;;;;;;;;;;;;ACAA;AAEA;;;;AAGO,SAASA,cAAT,GAA2B;AAChC,QAAMC,MAAM,GAAGC,yBAAM,CAACC,WAAP,CAAmB,EAAnB,EAAuBC,QAAvB,CAAgC,KAAhC,CAAf;AACA,SAAOF,yBAAM,CAACG,UAAP,CAAkB,QAAlB,EAA4BC,MAA5B,CAAmCL,MAAnC,EAA2CM,MAA3C,CAAkD,KAAlD,CAAP;AACD;AAED;;;;;;;AAMO,SAASC,eAAT,CAA0BC,IAA1B,EAAgC;AACrC,SAAOC,MAAM,CAACC,IAAI,CAACC,KAAL,CAAWH,IAAI,GAAGE,IAAI,CAACV,MAAL,EAAP,GAAuB,KAAlC,IAA2CU,IAAI,CAACV,MAAL,EAA5C,CAAN,CAAiEY,SAAjE,CAA2E,CAA3E,EAA8E,CAA9E,CAAP;AACD;AAED;;;;;;;AAMO,SAASC,QAAT,CAAmBC,CAAnB,EAAsB;AAC3B,SAAO,OAAOA,CAAP,KAAa,QAAb,IAAyBA,CAAC,YAAYL,MAA7C;AACD;AAED;;;;;;;AAMO,SAASM,WAAT,CAAsBC,IAAtB,EAA4B;AACjC,MAAI,CAACH,QAAQ,CAACG,IAAD,CAAb,EAAqB;AACnB,WAAO,KAAP;AACD;;AAED,MAAIA,IAAI,CAACC,MAAL,KAAgB,CAApB,EAAuB;AACrB,WAAO,KAAP;AACD;;AAED,MAAI,QAAQC,IAAR,CAAaF,IAAb,MAAuB,KAA3B,EAAkC;AAChC,WAAO,KAAP;AACD;;AAED,SAAO,IAAP;AACD;AAED;;;;;;AAKO,SAASG,WAAT,CAAsBX,IAAtB,EAA4B;AACjC,SAAO,IAAP;AACD;AAED;;;;;;AAKO,SAASY,cAAT,CAAyBC,OAAzB,EAAkC;AACvC,SAAON,WAAW,CAACM,OAAO,CAACL,IAAT,CAAX,IAA6BG,WAAW,CAACE,OAAO,CAACb,IAAT,CAA/C;AACD,C;;ACpED;;;;;;AAMO,MAAMc,OAAN,CAAc;AACnBC,aAAW,CAAE;AAAEP,QAAF;AAAQR;AAAR,GAAF,EAAkB;AAC3B,SAAKQ,IAAL,GAAYA,IAAZ;AACA,SAAKR,IAAL,GAAYA,IAAZ;AACD;;AAJkB;AAOrB;;;;;;AAKO,MAAMgB,UAAN,CAAiB;AACtBD,aAAW,CAAEE,OAAF,EAAW;AACpB,SAAKA,OAAL,GAAeA,OAAf;AACD;;AAHqB,C;;;;;;;;;AClBxB;AACA;AAEA;AACA;AAEA,MAAMC,WAAW,GAAG,GAApB,C,CAAwB;;AACxB,MAAMC,aAAa,GAAG,KAAK,EAAL,GAAU,EAAV,GAAe,CAArC,C,CAAuC;;AAEvC;;;;;;;AAMA,MAAMC,WAAN,CAAY;AACV;;;AAGAL,aAAW,CAAEM,WAAF,EAAe;AACxB,SAAKC,QAAL,GAAgBC,mCAAS,CAACF,WAAW,CAACG,GAAb,CAAT,CAA2BC,IAA3B,CAAgCJ,WAAhC,CAAhB;AACA,SAAKK,QAAL,GAAgBH,mCAAS,CAACF,WAAW,CAACM,GAAb,CAAT,CAA2BF,IAA3B,CAAgCJ,WAAhC,CAAhB;AACA,SAAKO,WAAL,GAAmBL,mCAAS,CAACF,WAAW,CAACQ,MAAb,CAAT,CAA8BJ,IAA9B,CAAmCJ,WAAnC,CAAnB;AACA,SAAKS,QAAL,GAAgBP,mCAAS,CAACF,WAAW,CAACU,GAAb,CAAT,CAA2BN,IAA3B,CAAgCJ,WAAhC,CAAhB;AACA,SAAKW,WAAL,GAAmBT,mCAAS,CAACF,WAAW,CAACY,MAAb,CAAT,CAA8BR,IAA9B,CAAmCJ,WAAnC,CAAnB;AAEA,SAAKa,WAAL,GAAmB,KAAnB;AAEAb,eAAW,CAACc,EAAZ,CAAe,OAAf,EAAwB,MAAM;AAC5B,WAAKD,WAAL,GAAmB,IAAnB;AACAE,aAAO,CAACC,GAAR,CAAY,iBAAZ;AACD,KAHD;AAKAhB,eAAW,CAACc,EAAZ,CAAe,OAAf,EAAwB,MAAM;AAC5B,WAAKD,WAAL,GAAmB,KAAnB;AACAE,aAAO,CAACC,GAAR,CAAY,oBAAZ;AACD,KAHD;AAID;AAED;;;;;;;AAKA,QAAMC,SAAN,CAAiBtC,IAAjB,EAAuB;AACrB,UAAMuC,GAAG,GAAG,MAAM,KAAKX,WAAL,CAAiB5B,IAAjB,CAAlB;AACA,WAAOuC,GAAG,KAAK,CAAf;AACD;AAED;;;;;;;AAKA,QAAMC,YAAN,GAAsB;AACpB,QAAIC,WAAW,GAAG,KAAlB;AACA,QAAIzC,IAAI,GAAG,EAAX;;AAEA,OAAG;AACDA,UAAI,GAAGT,cAAc,EAArB;AACAkD,iBAAW,GAAG,MAAM,KAAKH,SAAL,CAAetC,IAAf,CAApB;AACD,KAHD,QAGSyC,WAHT;;AAKA,WAAOzC,IAAP;AACD;AAED;;;;;;;AAKA,QAAM0C,YAAN,CAAoB1C,IAApB,EAA0B;AACxB,UAAM2C,WAAW,GAAGC,8BAAU,CAAC5C,IAAD,CAA9B;AACA,QAAIyC,WAAW,GAAG,KAAlB;AACA,QAAIjC,IAAI,GAAG,QAAX;;AAEA,OAAG;AACDA,UAAI,GAAGT,eAAe,CAAC4C,WAAD,CAAtB;AACAF,iBAAW,GAAG,MAAM,KAAKH,SAAL,CAAe9B,IAAf,CAApB;AACD,KAHD,QAGSiC,WAHT;;AAKA,WAAOjC,IAAP;AACD;AAED;;;;;;;;AAMA,QAAMqC,eAAN,GAAyB;AACvB,UAAM7C,IAAI,GAAG,MAAM,KAAKwC,YAAL,EAAnB;AACA,UAAMhC,IAAI,GAAG,MAAM,KAAKkC,YAAL,CAAkB1C,IAAlB,CAAnB;AAEA,UAAM8C,SAAS,GAAG,OAAM,KAAKpB,QAAL,CAAc1B,IAAd,EAAoBQ,IAApB,EAA0B,IAA1B,EAAgCU,WAAhC,CAAN,MAAuD,IAAzE;AACA,UAAM6B,SAAS,GAAG,OAAM,KAAKrB,QAAL,CAAclB,IAAd,EAAoBR,IAApB,EAA0B,IAA1B,EAAgCkB,WAAhC,CAAN,MAAuD,IAAzE;;AAEA,QAAI4B,SAAS,IAAIC,SAAjB,EAA4B;AAC1B,aAAO,IAAIjC,OAAJ,CAAY;AAAEN,YAAF;AAAQR;AAAR,OAAZ,CAAP;AACD,KAFD,MAEO;AACL,YAAM,IAAIgD,KAAJ,CAAU,uBAAV,CAAN;AACD;AACF;AAED;;;;;;;;;AAOA,QAAMC,kBAAN,CAA0BzC,IAA1B,EAAgC;AAC9B,QAAID,WAAW,CAACC,IAAD,CAAf,EAAuB;AACrB,YAAMqB,MAAM,GAAG,MAAM,KAAKS,SAAL,CAAe9B,IAAf,CAArB;;AAEA,UAAIqB,MAAJ,EAAY;AACV,cAAM7B,IAAI,GAAG,MAAM,KAAKsB,QAAL,CAAcd,IAAd,CAAnB;AACA,cAAM,KAAKsB,QAAL,CAActB,IAAd,CAAN;AACA,cAAM,KAAKwB,WAAL,CAAiBhC,IAAjB,EAAuBmB,aAAvB,CAAN;AAEA,eAAO,IAAIL,OAAJ,CAAY;AAAEN,cAAF;AAAQR;AAAR,SAAZ,CAAP;AACD;AACF;;AACD,WAAO,EAAP;AACD;AAED;;;;;;;;;AAOA,QAAMkD,eAAN,CAAuBrC,OAAvB,EAAgC;AAC9B,QAAII,OAAO,GAAG,KAAd;;AAEA,QAAIL,cAAc,CAACC,OAAD,CAAlB,EAA6B;AAC3B,YAAMsC,UAAU,GAAG,MAAM,KAAKb,SAAL,CAAezB,OAAO,CAACb,IAAvB,CAAzB;;AAEA,UAAImD,UAAJ,EAAgB;AACd,cAAM3C,IAAI,GAAG,MAAM,KAAKc,QAAL,CAAcT,OAAO,CAACb,IAAtB,CAAnB;;AAEA,YAAIa,OAAO,CAACL,IAAR,KAAiBA,IAArB,EAA2B;AACzBS,iBAAO,GAAG,IAAV;AACD;AACF;AACF;;AACD,WAAO,IAAID,UAAJ,CAAeC,OAAf,CAAP;AACD;;AArIS;;AAwIGG,4DAAf,E;;;;;;ACvJA;;;;;;;;;;AAUA;AAEe,MAAMgC,OAAN,CAAU;AACvBrC,aAAW,CAAE;AACXsC,OADW;AAEXC,UAFW;AAGXC,SAHW;AAIXC,cAJW;AAKXC;AALW,MAMT,EANO,EAMH;AACN,SAAKF,KAAL,GAAaA,KAAb;AAEA,SAAKC,UAAL,GAAkBA,UAAlB;AAEA,SAAKH,GAAL,GAAWA,GAAX;AACA,SAAKC,MAAL,GAAcA,MAAd;AAEA,SAAKD,GAAL,CAASK,GAAT,CAAaC,8BAAU,CAACC,UAAX,CAAsB;AAAEC,cAAQ,EAAE;AAAZ,KAAtB,CAAb;AACA,SAAKR,GAAL,CAASK,GAAT,CAAaC,8BAAU,CAACG,IAAX,EAAb;AAEA,SAAKT,GAAL,CAAS7B,GAAT,CAAa,aAAb,EAA4B,KAAKgC,UAAjC,EAA6C,KAAKO,WAAL,CAAiBtC,IAAjB,CAAsB,IAAtB,CAA7C;AACA,SAAK4B,GAAL,CAAS7B,GAAT,CAAa,eAAb,EAA8B,KAAKgC,UAAnC,EAA+C,KAAKQ,YAAL,CAAkBvC,IAAlB,CAAuB,IAAvB,CAA/C;AACA,SAAK4B,GAAL,CAASY,IAAT,CAAc,oBAAd,EAAoC,KAAKT,UAAzC,EAAqD,KAAKU,iBAAL,CAAuBzC,IAAvB,CAA4B,IAA5B,CAArD;AACA,SAAK4B,GAAL,CAASY,IAAT,CAAc,uBAAd,EAAuC,KAAKT,UAA5C,EAAwD,KAAKW,oBAAL,CAA0B1C,IAA1B,CAA+B,IAA/B,CAAxD;AAEA,SAAK2C,SAAL,GAAiBX,MAAjB;AACD;;AAEDM,aAAW,CAAEM,GAAF,EAAO9B,GAAP,EAAY;AACrB,QAAI;AACF,YAAMkB,MAAM,GAAG,KAAKW,SAAL,EAAf;AACA,aAAO7B,GAAG,CAACuB,IAAJ,CAASL,MAAT,CAAP;AACD,KAHD,CAGE,OAAOa,CAAP,EAAU;AACVlC,aAAO,CAACC,GAAR,CAAYiC,CAAZ;AACA,aAAO/B,GAAG,CAACgC,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,uBAArB,CAAP;AACD;AACF;;AAEDR,cAAY,CAAEK,GAAF,EAAO9B,GAAP,EAAY;AACtB,SAAKgB,KAAL,CAAWV,eAAX,GAA6B4B,IAA7B,CAAkC5D,OAAO,IAAI;AAC3C,aAAO0B,GAAG,CAACuB,IAAJ,CAASjD,OAAT,CAAP;AACD,KAFD,EAEG6D,KAFH,CAESC,GAAG,IAAI;AACdvC,aAAO,CAACC,GAAR,CAAYsC,GAAZ;AACA,aAAOpC,GAAG,CAACgC,MAAJ,CAAW,GAAX,CAAP;AACD,KALD;AAMD,GA3CsB,CA6CvB;;;AACAL,mBAAiB,CAAEG,GAAF,EAAO9B,GAAP,EAAY;AAC3B,QAAI,CAAC8B,GAAG,CAACO,IAAJ,CAASpE,IAAd,EAAoB;AAClB,aAAO+B,GAAG,CAACgC,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,mCAArB,CAAP;AACD;;AAED,SAAKjB,KAAL,CAAWN,kBAAX,CAA8BoB,GAAG,CAACO,IAAJ,CAASpE,IAAvC,EAA6CiE,IAA7C,CAAkD5D,OAAO,IAAI;AAC3D,aAAO0B,GAAG,CAACuB,IAAJ,CAASjD,OAAT,CAAP;AACD,KAFD,EAEG6D,KAFH,CAESC,GAAG,IAAI;AACdvC,aAAO,CAACC,GAAR,CAAYsC,GAAZ;AACA,aAAOpC,GAAG,CAACgC,MAAJ,CAAW,GAAX,CAAP;AACD,KALD;AAMD,GAzDsB,CA2DvB;;;AACAJ,sBAAoB,CAAEE,GAAF,EAAO9B,GAAP,EAAY;AAC9B,QAAI,CAAC8B,GAAG,CAACO,IAAJ,CAAS/D,OAAd,EAAuB;AACrB,aAAO0B,GAAG,CAACgC,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,sCAArB,CAAP;AACD;;AAED,SAAKjB,KAAL,CAAWL,eAAX,CAA2BmB,GAAG,CAACO,IAAJ,CAAS/D,OAApC,EAA6C4D,IAA7C,CAAkDI,UAAU,IAAI;AAC9D,aAAOtC,GAAG,CAACuB,IAAJ,CAASe,UAAT,CAAP;AACD,KAFD,EAEGH,KAFH,CAESC,GAAG,IAAI;AACdvC,aAAO,CAACC,GAAR,CAAYsC,GAAZ;AACA,aAAOpC,GAAG,CAACgC,MAAJ,CAAW,GAAX,CAAP;AACD,KALD;AAMD;;AAvEsB,C;;ACZlB,SAASO,MAAT,CAAiBC,IAAjB,EAAuB;AAC5B,MAAI;AACF,WAAOC,IAAI,CAACC,KAAL,CAAWF,IAAX,CAAP;AACD,GAFD,CAEE,OAAOT,CAAP,EAAU;AACV,WAAO,IAAP;AACD;AACF;AAEM,SAASY,MAAT,CAAiBC,IAAjB,EAAuBJ,IAAI,GAAG,EAA9B,EAAkC;AACvC,SAAOC,IAAI,CAACI,SAAL,CAAe;AAAED,QAAF;AAAQJ;AAAR,GAAf,CAAP;AACD,C;;ACVM,MAAMM,uBAAuB,GAAG,GAAhC;AAEA,MAAMC,iBAAiB,GAAG,mBAA1B;AACA,MAAMC,gBAAgB,GAAG,kBAAzB;AACA,MAAMC,IAAI,GAAG,MAAb,C;;;;;ACJP;AACA;AAEA;AAEAC,mBAAO,CAAC,CAAD,CAAP,CAAgBC,OAAhB,CAAwBC,cAAxB,CAAuCC,KAAvC,GAA+C,CAA/C;AAEe,MAAMC,aAAN,CAAa;AAC1B9E,aAAW,CAAE;AAAEuC,UAAF;AAAUC;AAAV,GAAF,EAAqB;AAC9B,SAAKA,KAAL,GAAaA,KAAb;AAEA,SAAKuC,YAAL,GAAoB,IAAIC,sBAAJ,CAAoB;AACtCzC,YAAM,EAAEA,MAD8B;AAEtC0C,UAAI,EAAE;AAFgC,KAApB,CAApB;AAKA,SAAKC,eAAL,GAAuB;AACrB,yBAAmB,KAAKC,iBAAL,CAAuBzE,IAAvB,CAA4B,IAA5B,CADE;AAErBsD,UAAI,EAAE,KAAKoB,aAAL,CAAmB1E,IAAnB,CAAwB,IAAxB;AAFe,KAAvB;AAKA,SAAKqE,YAAL,CAAkB3D,EAAlB,CAAqB,YAArB,EAAmC,KAAKiE,YAAL,CAAkB3E,IAAlB,CAAuB,IAAvB,CAAnC;AAEA,SAAK4E,WAAL,GAAmB,EAAnB;AACD;;AAEDC,gBAAc,CAAEC,MAAF,EAAU;AACtB,QAAIvG,IAAI,GAAG,EAAX;;AACA,QAAIuG,MAAM,CAACC,QAAP,IAAmB,OAAOD,MAAM,CAACC,QAAd,KAA2B,QAAlD,EAA4D;AAC1DxG,UAAI,GAAGuG,MAAM,CAACC,QAAP,CAAgBxG,IAAvB;AACD;;AAED,QAAIuG,MAAM,CAACE,KAAP,IAAgBF,MAAM,CAACE,KAAP,CAAaD,QAA7B,IAAyC,OAAOD,MAAM,CAACE,KAAP,CAAaD,QAApB,KAAiC,QAA9E,EAAwF;AACtFxG,UAAI,GAAGuG,MAAM,CAACE,KAAP,CAAaD,QAAb,CAAsBxG,IAA7B;AACD;;AAED,SAAKqG,WAAL,CAAiBrG,IAAjB,IAAyB,IAAzB;;AAEA,QAAIuG,MAAM,CAACE,KAAX,EAAkB;AAChB,UAAIF,MAAM,CAACE,KAAP,CAAaC,UAAb,KAA4B,CAAhC,EAAmC;AACjCH,cAAM,CAACE,KAAP,CAAaE,KAAb;AACD;AACF;;AAED,QAAIJ,MAAM,CAACG,UAAP,KAAsB,CAA1B,EAA6B;AAC3BH,YAAM,CAACI,KAAP;AACD;AACF;;AAED,QAAMT,iBAAN,CAAyBK,MAAzB,EAAiC1F,OAAjC,EAA0C;AACxC,UAAMI,OAAO,GAAG,MAAM,KAAKsC,KAAL,CAAWL,eAAX,CAA2BrC,OAA3B,CAAtB;;AAEA,QAAI,CAACI,OAAL,EAAc;AACZsF,YAAM,CAAC/B,IAAP,CAAYe,gBAAZ;AACAgB,YAAM,CAACI,KAAP;AACA;AACD;;AAEDJ,UAAM,CAAC/B,IAAP,CAAYc,iBAAZ;AAEAiB,UAAM,CAACK,UAAP,GAAoB,aAApB;;AAEA,QAAI,KAAKP,WAAL,CAAiBxF,OAAO,CAACb,IAAzB,CAAJ,EAAoC;AAClC,YAAM6G,IAAI,GAAG,KAAKR,WAAL,CAAiBxF,OAAO,CAACb,IAAzB,CAAb;AACA6G,UAAI,CAACL,QAAL,GAAgB3F,OAAhB;AACAgG,UAAI,CAACJ,KAAL,GAAaF,MAAb;AACAA,YAAM,CAACE,KAAP,GAAeI,IAAf;AAEA,WAAKC,iBAAL,CAAuBP,MAAvB,EAA+B,gBAA/B,EAAiD;AAAEQ,mBAAW,EAAE,KAAf;AAAsBlG;AAAtB,OAAjD;AACA,WAAKiG,iBAAL,CAAuBD,IAAvB,EAA6B,gBAA7B,EAA+C;AAAEE,mBAAW,EAAE,IAAf;AAAqBlG;AAArB,OAA/C;AACD,KARD,MAQO;AACL0F,YAAM,CAACC,QAAP,GAAkB3F,OAAlB;AACA,WAAKwF,WAAL,CAAiBxF,OAAO,CAACb,IAAzB,IAAiCuG,MAAjC;AACD;AACF;;AAEDO,mBAAiB,CAAEP,MAAF,EAAUS,SAAV,EAAqBjC,IAAI,GAAG,EAA5B,EAAgC;AAC/C,QAAIwB,MAAM,IAAIA,MAAM,CAACG,UAAP,KAAsB,CAApC,EAAuC;AACrCH,YAAM,CAAC/B,IAAP,CAAYa,uBAAuB,GAAGH,MAAM,CAAC8B,SAAD,EAAYjC,IAAZ,CAA5C;AACD;AACF;;AAEDoB,eAAa,CAAEI,MAAF,EAAUxB,IAAV,EAAgB;AAC3B,QAAIwB,MAAM,IAAIA,MAAM,CAACE,KAAjB,IAA0BF,MAAM,CAACE,KAAP,CAAaC,UAAb,KAA4B,CAA1D,EAA6D;AAC3DH,YAAM,CAACE,KAAP,CAAajC,IAAb,CAAkBO,IAAlB;AACD;AACF;;AAEDqB,cAAY,CAAEG,MAAF,EAAU;AACpBA,UAAM,CAACpE,EAAP,CAAU,OAAV,EAAoB8E,MAAD,IAAY;AAC7B,WAAKX,cAAL,CAAoBC,MAApB;AACD,KAFD;AAGAA,UAAM,CAACpE,EAAP,CAAU,SAAV,EAAqB+E,UAAU,IAAI;AACjC;AACA,UAAIX,MAAM,IAAIA,MAAM,CAACE,KAAjB,IAA0BF,MAAM,CAACE,KAAP,CAAaC,UAAb,KAA4B,CAA1D,EAA6D;AAC3DH,cAAM,CAACI,KAAP;AACA;AACD;;AAED,UAAI,OAAOO,UAAP,KAAsB,QAAtB,IAAkCA,UAAU,CAACC,MAAX,CAAkB,CAAlB,MAAyB9B,uBAA/D,EAAwF;AACtF;AACA,cAAM+B,OAAO,GAAGtC,MAAM,CAACoC,UAAU,CAAC9G,SAAX,CAAqB,CAArB,CAAD,CAAtB;;AAEA,YAAIgH,OAAO,IAAI,KAAKnB,eAAL,CAAqBmB,OAAO,CAACjC,IAA7B,CAAf,EAAmD;AACjD,eAAKc,eAAL,CAAqBmB,OAAO,CAACjC,IAA7B,EAAmCkC,IAAnC,CAAwC,IAAxC,EAA8Cd,MAA9C,EAAsDa,OAAO,CAACrC,IAA9D;AACA;AACD;AACF,OAfgC,CAiBjC;;;AACA,UAAIwB,MAAM,CAACE,KAAP,IAAgBF,MAAM,CAACE,KAAP,CAAaC,UAAb,KAA4B,CAAhD,EAAmD;AACjDH,cAAM,CAACE,KAAP,CAAajC,IAAb,CAAkB0C,UAAlB;AACD;AACF,KArBD;AAsBD;;AA3GyB,C;;ACP5B;AAAA;AACA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAoDO,MAAMI,oBAAN,CAAoB;AACzB;;;;;;;;AAQAvG,aAAW,CAAEM,WAAF,EAAe;AACxBgC,OADwB;AAExBC,UAFwB;AAGxBE,cAAU,GAAG,EAHW;AAIxBC;AAJwB,MAKtB,EALO,EAKH;AACN,SAAKF,KAAL,GAAa,IAAInC,YAAJ,CAAUC,WAAV,CAAb;AAEA,SAAKkG,MAAL,GAAc,IAAI1B,aAAJ,CAAW;AACvBtC,WAAK,EAAE,KAAKA,KADW;AAEvBD;AAFuB,KAAX,CAAd;AAKA,SAAKkE,GAAL,GAAW,IAAIpE,OAAJ,CAAQ;AACjBG,WAAK,EAAE,KAAKA,KADK;AAEjBF,SAFiB;AAGjBC,YAHiB;AAIjBG,YAJiB;AAKjBD;AALiB,KAAR,CAAX;AAOD;;AA7BwB;AAgCZ8D,oGAAf,E","file":"peersox.server.js","sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory(require(\"ws\"));\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine(\"peersox\", [\"ws\"], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"peersox\"] = factory(require(\"ws\"));\n\telse\n\t\troot[\"peersox\"] = factory(root[\"ws\"]);\n})(global, function(__WEBPACK_EXTERNAL_MODULE__4__) {\nreturn "," \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 5);\n","module.exports = require(\"util\");","module.exports = require(\"crypto\");","module.exports = require(\"body-parser\");","module.exports = require(\"string-hash\");","module.exports = __WEBPACK_EXTERNAL_MODULE__4__;","import crypto from 'crypto'\n\n/**\n * Generate a random hex code in form of a sha256 hash.\n */\nexport function buildRandomHex () {\n  const random = crypto.randomBytes(64).toString('hex')\n  return crypto.createHash('sha256').update(random).digest('hex')\n}\n\n/**\n * Generate a random number.\n *\n * @param {String} hash A random hash as a String.\n * @returns {String} A random numerical code as a String.\n */\nexport function buildRandomCode (hash) {\n  return String(Math.round(hash * Math.random() * 89999) / Math.random()).substring(0, 6)\n}\n\n/**\n * Check if given argument is a String.\n *\n * @param {*} v\n * @returns {Boolean}\n */\nexport function isString (v) {\n  return typeof v === 'string' || v instanceof String\n}\n\n/**\n * Checks if the given code is valid.\n *\n * @param {String} code\n * @returns {Boolean}\n */\nexport function codeIsValid (code) {\n  if (!isString(code)) {\n    return false\n  }\n\n  if (code.length !== 6) {\n    return false\n  }\n\n  if (/^\\d+$/.test(code) === false) {\n    return false\n  }\n\n  return true\n}\n\n/**\n * Checks if the given string is a valid pairing hash.\n *\n * @param {String} hash\n */\nexport function hashIsValid (hash) {\n  return true\n}\n\n/**\n * Checks if the code and hash of the pairing are valid.\n *\n * @param {Pairing} pairing\n */\nexport function pairingIsValid (pairing) {\n  return codeIsValid(pairing.code) && hashIsValid(pairing.hash)\n}\n","/**\n * A pairing.\n *\n * @param {String} code The pairing code.\n * @param {String} hash The pairing hash.\n */\nexport class Pairing {\n  constructor ({ code, hash }) {\n    this.code = code\n    this.hash = hash\n  }\n}\n\n/**\n * A validation.\n *\n * @param {Boolean} isValid\n */\nexport class Validation {\n  constructor (isValid) {\n    this.isValid = isValid\n  }\n}\n","import { buildRandomCode, buildRandomHex, codeIsValid, pairingIsValid } from './utils/index.js'\nimport { Pairing, Validation } from './../common/classes'\n\nimport stringHash from 'string-hash'\nimport { promisify } from 'util'\n\nconst EXPIRE_CODE = 130 // 130 seconds\nconst EXPIRE_PAIRED = 60 * 60 * 24 * 7 // 7 days\n\n/**\n * Handles all things related to generating pairing codes and hashes\n * and validating them.\n *\n * @class\n */\nclass Store {\n  /**\n   * @param {RedisClient} redisClient\n   */\n  constructor (redisClient) {\n    this.redisGet = promisify(redisClient.get).bind(redisClient)\n    this.redisSet = promisify(redisClient.set).bind(redisClient)\n    this.redisExists = promisify(redisClient.exists).bind(redisClient)\n    this.redisDel = promisify(redisClient.del).bind(redisClient)\n    this.redisExpire = promisify(redisClient.expire).bind(redisClient)\n\n    this._redisReady = false\n\n    redisClient.on('ready', () => {\n      this._redisReady = true\n      console.log('Redis is ready.')\n    })\n\n    redisClient.on('error', () => {\n      this._redisReady = false\n      console.log('Redis has errored.')\n    })\n  }\n\n  /**\n   * Checks if the given hash exists.\n   *\n   * @param {String} hash\n   */\n  async keyExists (hash) {\n    const res = await this.redisExists(hash)\n    return res === 1\n  }\n\n  /**\n   * Generates a random hash and checks that it's unique.\n   *\n   * @returns {String} The generated hash.\n   */\n  async generateHash () {\n    let alreadyUsed = false\n    let hash = ''\n\n    do {\n      hash = buildRandomHex()\n      alreadyUsed = await this.keyExists(hash)\n    } while (alreadyUsed)\n\n    return hash\n  }\n\n  /**\n   * Generates a random code and checks that it's unique.\n   *\n   * @returns {String} The generated code.\n   */\n  async generateCode (hash) {\n    const numericHash = stringHash(hash)\n    let alreadyUsed = false\n    let code = '000000'\n\n    do {\n      code = buildRandomCode(numericHash)\n      alreadyUsed = await this.keyExists(code)\n    } while (alreadyUsed)\n\n    return code\n  }\n\n  /**\n   * Generate a pairing combination of hash and code.\n   * Both are stored in redis with a short expire time.\n   *\n   * @returns {Pairing} The generated pairing.\n   */\n  async generatePairing () {\n    const hash = await this.generateHash()\n    const code = await this.generateCode(hash)\n\n    const hashIsSet = await this.redisSet(hash, code, 'EX', EXPIRE_CODE) === 'OK'\n    const codeIsSet = await this.redisSet(code, hash, 'EX', EXPIRE_CODE) === 'OK'\n\n    if (hashIsSet && codeIsSet) {\n      return new Pairing({ code, hash })\n    } else {\n      throw new Error('PairingGenerateFailed')\n    }\n  }\n\n  /**\n   * Gets the pairing from a code. If it exists, the code is deleted\n   * and the expire time of the hash increased.\n   *\n   * @param {String} code The code to get the pairing from.\n   * @returns {(Pairing|Object)} A pairing or an empty object if no pairing was found.\n   */\n  async getPairingFromCode (code) {\n    if (codeIsValid(code)) {\n      const exists = await this.keyExists(code)\n\n      if (exists) {\n        const hash = await this.redisGet(code)\n        await this.redisDel(code)\n        await this.redisExpire(hash, EXPIRE_PAIRED)\n\n        return new Pairing({ code, hash })\n      }\n    }\n    return {}\n  }\n\n  /**\n   * Check if the given pairing is valid, both as values and as\n   * stored keys in redis.\n   *\n   * @param {Pairing} pairing\n   * @returns {boolean} Object with isValid property.\n   */\n  async validatePairing (pairing) {\n    let isValid = false\n\n    if (pairingIsValid(pairing)) {\n      const hashExists = await this.keyExists(pairing.hash)\n\n      if (hashExists) {\n        const code = await this.redisGet(pairing.hash)\n\n        if (pairing.code === code) {\n          isValid = true\n        }\n      }\n    }\n    return new Validation(isValid)\n  }\n}\n\nexport default Store\n","/**\n * drawmote server\n *\n * The server manages the generation and validation of pairing codes and hashes.\n * They are stored in redis, for local development redis-mock is used.\n *\n * Generated Pairings are only valid for a short amount of time. If they are not\n * validated in that time slot, they are deleted. If they are validated, the code\n * is removed from redis, while the hash's expire time is increased.\n */\nimport bodyParser from 'body-parser'\n\nexport default class API {\n  constructor ({\n    app,\n    server,\n    store,\n    middleware,\n    config\n  } = {}) {\n    this.store = store\n\n    this.middleware = middleware\n\n    this.app = app\n    this.server = server\n\n    this.app.use(bodyParser.urlencoded({ extended: true }))\n    this.app.use(bodyParser.json())\n\n    this.app.get('/api/config', this.middleware, this.routeConfig.bind(this))\n    this.app.get('/api/code/get', this.middleware, this.routeCodeGet.bind(this))\n    this.app.post('/api/code/validate', this.middleware, this.routeCodeValidate.bind(this))\n    this.app.post('/api/pairing/validate', this.middleware, this.routePairingValidate.bind(this))\n\n    this.getConfig = config\n  }\n\n  routeConfig (req, res) {\n    try {\n      const config = this.getConfig()\n      return res.json(config)\n    } catch (e) {\n      console.log(e)\n      return res.status(503).send('Error getting config.')\n    }\n  }\n\n  routeCodeGet (req, res) {\n    this.store.generatePairing().then(pairing => {\n      return res.json(pairing)\n    }).catch(err => {\n      console.log(err)\n      return res.status(503)\n    })\n  }\n\n  // Return a pairing or an empty object if the given code is valid.\n  routeCodeValidate (req, res) {\n    if (!req.body.code) {\n      return res.status(400).send('Did not specify code to validate.')\n    }\n\n    this.store.getPairingFromCode(req.body.code).then(pairing => {\n      return res.json(pairing)\n    }).catch(err => {\n      console.log(err)\n      return res.status(503)\n    })\n  }\n\n  // Return a Validation if the given pairing is valid.\n  routePairingValidate (req, res) {\n    if (!req.body.pairing) {\n      return res.status(400).send('Did not specify pairing to validate.')\n    }\n\n    this.store.validatePairing(req.body.pairing).then(validation => {\n      return res.json(validation)\n    }).catch(err => {\n      console.log(err)\n      return res.status(503)\n    })\n  }\n}\n","export function decode (data) {\n  try {\n    return JSON.parse(data)\n  } catch (e) {\n    return null\n  }\n}\n\nexport function encode (name, data = {}) {\n  return JSON.stringify({ name, data })\n}\n","export const INTERNAL_MESSAGE_PREFIX = '§'\n\nexport const HANDSHAKE_SUCCESS = 'HANDSHAKE_SUCCESS'\nexport const HANDSHAKE_FAILED = 'HANDSHAKE_FAILED'\nexport const PING = 'PING'\n","import { encode, decode } from '../common/dataparser'\nimport { INTERNAL_MESSAGE_PREFIX, HANDSHAKE_SUCCESS, HANDSHAKE_FAILED } from '../common/settings'\n\nimport { Server as WebSocketServer } from 'ws'\n\nrequire('util').inspect.defaultOptions.depth = 0\n\nexport default class Socket {\n  constructor ({ server, store }) {\n    this.store = store\n\n    this.socketserver = new WebSocketServer({\n      server: server,\n      path: '/ws'\n    })\n\n    this.messageHandlers = {\n      'client.register': this.onMessageRegister.bind(this),\n      data: this.onMessageData.bind(this)\n    }\n\n    this.socketserver.on('connection', this.onConnection.bind(this))\n\n    this.connections = {}\n  }\n\n  onMessageClose (client) {\n    let hash = ''\n    if (client._pairing && typeof client._pairing === 'object') {\n      hash = client._pairing.hash\n    }\n\n    if (client._peer && client._peer._pairing && typeof client._peer._pairing === 'object') {\n      hash = client._peer._pairing.hash\n    }\n\n    this.connections[hash] = null\n\n    if (client._peer) {\n      if (client._peer.readyState === 1) {\n        client._peer.close()\n      }\n    }\n\n    if (client.readyState === 1) {\n      client.close()\n    }\n  }\n\n  async onMessageRegister (client, pairing) {\n    const isValid = await this.store.validatePairing(pairing)\n\n    if (!isValid) {\n      client.send(HANDSHAKE_FAILED)\n      client.close()\n      return\n    }\n\n    client.send(HANDSHAKE_SUCCESS)\n\n    client.binaryType = 'arraybuffer'\n\n    if (this.connections[pairing.hash]) {\n      const peer = this.connections[pairing.hash]\n      peer._pairing = pairing\n      peer._peer = client\n      client._peer = peer\n\n      this.sendInternalEvent(client, 'peer.connected', { isInitiator: false, pairing })\n      this.sendInternalEvent(peer, 'peer.connected', { isInitiator: true, pairing })\n    } else {\n      client._pairing = pairing\n      this.connections[pairing.hash] = client\n    }\n  }\n\n  sendInternalEvent (client, eventName, data = {}) {\n    if (client && client.readyState === 1) {\n      client.send(INTERNAL_MESSAGE_PREFIX + encode(eventName, data))\n    }\n  }\n\n  onMessageData (client, data) {\n    if (client && client._peer && client._peer.readyState === 1) {\n      client._peer.send(data)\n    }\n  }\n\n  onConnection (client) {\n    client.on('close', (closed) => {\n      this.onMessageClose(client)\n    })\n    client.on('message', messageRaw => {\n      // Close the connection if the peer connection has closed.\n      if (client && client._peer && client._peer.readyState === 3) {\n        client.close()\n        return\n      }\n\n      if (typeof messageRaw === 'string' && messageRaw.charAt(0) === INTERNAL_MESSAGE_PREFIX) {\n        // Handle the case when it's an internal string message.\n        const message = decode(messageRaw.substring(1))\n\n        if (message && this.messageHandlers[message.name]) {\n          this.messageHandlers[message.name].call(this, client, message.data)\n          return\n        }\n      }\n\n      // Directly send the message to the peer if its connected.\n      if (client._peer && client._peer.readyState === 1) {\n        client._peer.send(messageRaw)\n      }\n    })\n  }\n}\n","import Store from './server/Store.js'\nimport API from './server/API.js'\nimport Socket from './server/Socket.js'\n\n/**\n * The server manages the generation and validation of pairing codes and hashes.\n * They are stored in redis, for local development redis-mock is used.\n *\n * Generated Pairings are only valid for a short amount of time. If they are not\n * validated in that time slot, they are deleted. If they are validated, the\n * code is removed from redis, while the hash's expire time is increased.\n *\n * @example <caption>Minimal</caption>\n * // Start a server on port 3000, using redis-mock for storage.\n * // This is not meant for production use.\n *\n * const PeerSoxServer = require('peersox/lib/peersox.server.js').default\n * new PeerSoxServer()\n *\n * @example <caption>Redis server with express-bruteforce</caption>\n * // Connect and use a redis server for storage and provide an express\n * // middleware that prevents brute force attacks on the server.\n *\n * const PeerSoxServer = require('peersox/lib/peersox.server.js').default\n * const ExpressBrute = require('express-brute')\n * const redis = require('redis')\n * const BruteRedis = require('express-brute-redis')\n *\n * // Create a new redis client.\n * const redisClient = redis.createClient('//localhost:6379')\n *\n * // Init the PeerSox server when the redis client is ready.\n * redisClient.on('ready', function () {\n *   console.log('Connected to Redis at')\n *\n *   // Use the redis client as the store for express-brute.\n *   const bruteStore = new BruteRedis({\n *     client: redisClient\n *   })\n *\n *   // Instantiate the express-brute middleware.\n *   const bruteforce = new ExpressBrute(bruteStore, {\n *     freeRetries: 20\n *   })\n *\n *   // Instantiate the PeerSox server.\n *   new PeerSoxServer({\n *     storage: redisClient,\n *     middleware: [\n *       bruteforce.prevent\n *     ]\n *   })\n * })\n *\n * @class\n */\nexport class PeerSoxServer {\n  /**\n   * @param {RedisClient} redisClient The redis client to use for the store.\n   * @param {object} options\n   * @param {object} options.app An existing express app.\n   * @param {object} options.server An existing http server.\n   * @param {number} options.port The port on which the server should run.\n   * @param {array} options.middleware Additional middleware for use in express.\n   */\n  constructor (redisClient, {\n    app,\n    server,\n    middleware = [],\n    config\n  } = {}) {\n    this.store = new Store(redisClient)\n\n    this.socket = new Socket({\n      store: this.store,\n      server\n    })\n\n    this.api = new API({\n      store: this.store,\n      app,\n      server,\n      config,\n      middleware\n    })\n  }\n}\n\nexport default PeerSoxServer\n"],"sourceRoot":""}